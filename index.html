<!doctype html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>CozyHub Admin</title>
<link rel="stylesheet" href="../assets/style.css">
<script src="../assets/lang.js"></script><script src="../assets/config.js"></script>
<style>
.admin{width:min(1100px,96vw);display:grid;grid-template-columns:260px 1fr;gap:18px;align-items:start}
.side,.main{background:rgba(10,15,30,.92);border:1px solid rgba(0,255,255,.25);border-radius:22px;padding:18px;box-shadow:0 0 40px rgba(0,255,255,.18)}
.tab{display:block;width:100%;padding:12px 12px;margin:8px 0;border-radius:12px;background:rgba(0,0,0,.55);border:1px solid rgba(0,255,255,.18);color:#fff;cursor:pointer;text-align:left}
.tab.active{border-color:rgba(0,255,255,.55);box-shadow:0 0 18px rgba(0,255,255,.25)}
.h{font-size:18px;color:var(--cyan);margin:0 0 10px}
.pane{display:none}
.pane.show{display:block}
.input{width:100%;padding:12px 12px;border-radius:12px;background:#000;border:1px solid rgba(0,255,255,.25);color:#fff}
.row{display:flex;gap:10px;flex-wrap:wrap}
.badge{display:inline-block;padding:6px 10px;border-radius:10px;font-size:12px;font-weight:700}
.badge.ok{background:rgba(61,255,154,.12);color:var(--ok);border:1px solid rgba(61,255,154,.35)}
.badge.warn{background:rgba(255,180,0,.12);color:var(--warn);border:1px solid rgba(255,180,0,.35)}
.badge.bad{background:rgba(255,75,75,.12);color:var(--bad);border:1px solid rgba(255,75,75,.35)}
pre{background:#000;padding:12px;border-radius:12px;border:1px solid rgba(0,255,255,.25);word-break:break-all}
</style>
</head><body>
<div class="bg"></div><canvas id="stars"></canvas>
<div class="admin">
  <div class="side">
    <div class="h">CozyHub Admin</div>
    <div id="login">
      <input id="pw" class="input" type="password" placeholder="Admin password">
      <button class="btn" style="margin-top:10px" onclick="login()">Login</button>
      <div id="loginMsg" class="msg"></div>
    </div>
    <div id="menu" style="display:none">
      <button class="tab active" data-tab="dash">Dashboard</button>
      <button class="tab" data-tab="keys">Keys</button>
      <button class="tab" data-tab="web">Web Control</button>
      <button class="tab" data-tab="rotation">Rotation</button>
      <button class="btn" style="margin-top:10px;background:#ff4b4b;color:#fff" onclick="logout()">Logout</button>
    </div>
  </div>
  <div class="main">
    <div id="dash" class="pane show">
      <div class="h">Dashboard</div>
      <div class="row">
        <div class="badge ok">Keys: <span id="k">-</span></div>
        <div class="badge ok">Tasks: <span id="t">-</span></div>
      </div>
    </div>
    <div id="keys" class="pane">
      <div class="h">Keys</div>
      <div class="row">
        <input id="ip" class="input" placeholder="IP" style="flex:1">
        <input id="hours" class="input" placeholder="Ban hours" style="width:140px" value="24">
      </div>
      <div class="row">
        <button class="btn" style="width:auto;padding:10px 14px" onclick="ban()">Ban</button>
        <button class="btn" style="width:auto;padding:10px 14px" onclick="unban()">Unban</button>
        <button class="btn" style="width:auto;padding:10px 14px" onclick="resetKey()">Reset Key</button>
      </div>
      <div id="keysMsg" class="msg"></div>
    </div>
    <div id="web" class="pane">
      <div class="h">Web Control</div>
      <div class="row">
        <button class="btn" style="width:auto;padding:10px 14px" onclick="maint(true)">ON</button>
        <button class="btn" style="width:auto;padding:10px 14px" onclick="maint(false)">OFF</button>
        <span id="m" class="badge ok">-</span>
      </div>
    </div>
    <div id="rotation" class="pane">
      <div class="h">Rotation</div>
      <div class="row">
        <span id="rb" class="badge ok">Loading...</span>
        <span id="rl" style="opacity:.7;font-size:12px"></span>
      </div>
      <button class="btn" style="width:auto;padding:10px 14px" onclick="rotDone()">Rotate Done</button>
      <div style="margin-top:10px">
        <button class="btn" style="width:auto;padding:10px 14px" onclick="gen()">Generate Secret</button>
        <div id="wrap" style="display:none;margin-top:10px">
          <pre id="box"></pre>
          <div class="row">
            <span id="str" class="badge ok">Strong</span>
            <button class="btn" style="width:auto;padding:10px 14px" onclick="copy()">Copy</button>
            <span id="timer" style="opacity:.65;font-size:12px"></span>
          </div>
        </div>
      </div>
      <div style="margin-top:12px">
        <b>History</b>
        <div id="hist" style="margin-top:8px;font-size:13px;opacity:.9"></div>
      </div>
    </div>
  </div>
</div>
<script src="../assets/stars.js"></script>
<script>
applyLang("en");
const API=COZY.api.admin;
const tok=()=>localStorage.getItem("admTok")||"";
const setAuthed=(v)=>{document.getElementById("login").style.display=v?"none":"block";document.getElementById("menu").style.display=v?"block":"none";};
document.querySelectorAll(".tab").forEach(b=>b.onclick=()=>{document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));b.classList.add("active");
document.querySelectorAll(".pane").forEach(p=>p.classList.remove("show"));document.getElementById(b.dataset.tab).classList.add("show");});
async function api(path,body){
  const r=await fetch(API+path,{method:body?"POST":"GET",headers:{"Content-Type":"application/json","x-admin-token":tok()},body:body?JSON.stringify(body):undefined});
  return await r.json();
}
async function login(){
  try{
    const pw=document.getElementById("pw").value.trim();
    const d=await api("/admin/login",{password:pw});
    if(!d.ok) throw 0;
    localStorage.setItem("admTok",d.token);
    setAuthed(true); await refresh();
  }catch{document.getElementById("loginMsg").className="msg show error";document.getElementById("loginMsg").textContent="Login failed";}
}
async function logout(){localStorage.removeItem("admTok");setAuthed(false);try{await api("/admin/logout",{});}catch(e){}}
async function refresh(){const d=await api("/admin/stats");document.getElementById("k").textContent=d.keys??"-";document.getElementById("t").textContent=d.tasks??"-";
const m=await api("/admin/maint");document.getElementById("m").className="badge "+(m.on?"warn":"ok");document.getElementById("m").textContent=m.on?"ON":"OFF";
await rotLoad();}
async function ban(){const ip=document.getElementById("ip").value.trim();const hours=Number(document.getElementById("hours").value||24);
const d=await api("/admin/ban",{ip,hours});document.getElementById("keysMsg").className="msg show "+(d.ok?"ok":"error");document.getElementById("keysMsg").textContent=d.ok?"OK":"Fail";}
async function unban(){const ip=document.getElementById("ip").value.trim();const d=await api("/admin/unban",{ip});document.getElementById("keysMsg").className="msg show "+(d.ok?"ok":"error");document.getElementById("keysMsg").textContent=d.ok?"OK":"Fail";}
async function resetKey(){const ip=document.getElementById("ip").value.trim();const d=await api("/admin/resetkey",{ip});document.getElementById("keysMsg").className="msg show "+(d.ok?"ok":"error");document.getElementById("keysMsg").textContent=d.ok?"OK":"Fail";}
async function maint(on){await api("/admin/maint",{on});await refresh();}
async function rotDone(){await api("/admin/rotation/mark",{type:"JWT+SYSTEM"});await rotLoad();}
async function rotLoad(){
  const d=await api("/admin/rotation/status");
  const rb=document.getElementById("rb");
  rb.className="badge "+(d.level==="danger"?"bad":(d.level==="warn"?"warn":"ok"));
  rb.textContent=d.level==="ok"?("Next in "+d.leftDays+" days"):(d.level==="warn"?("Soon "+d.leftDays+" days"):"Overdue");
  document.getElementById("rl").textContent=d.last?("Last: "+new Date(d.last).toLocaleString()):"Last: Never";
  const h=await api("/admin/rotation/history");
  document.getElementById("hist").innerHTML=(h.list||[]).slice(0,20).map(x=>`• ${new Date(x.time).toLocaleString()} — ${x.type} — ${x.ip||""}`).join("<br>")||"-";
}
let hideInt=null,left=30;
function gen(){
  const bytes=crypto.getRandomValues(new Uint8Array(48));
  const s=Array.from(bytes).map(b=>b.toString(16).padStart(2,"0")).join("");
  document.getElementById("wrap").style.display="block";
  document.getElementById("box").textContent=s;
  document.getElementById("str").className="badge ok";
  clearInterval(hideInt); left=30;
  document.getElementById("timer").textContent="Auto hide in 30s";
  hideInt=setInterval(()=>{left--;document.getElementById("timer").textContent="Auto hide in "+left+"s";if(left<=0){clearInterval(hideInt);document.getElementById("wrap").style.display="none";}},1000);
}
function copy(){navigator.clipboard.writeText(document.getElementById("box").textContent.trim());}
(function(){ if(tok()){ setAuthed(true); refresh().catch(()=>{});} })();
</script>
</body></html>
